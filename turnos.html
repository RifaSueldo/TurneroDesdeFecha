<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mis Turnos</title>
</head>
<body>

<h1>Mis Turnos</h1>
<div id="ticketsContainer">Cargando...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyFGGpfszwxPYakYsW-o5H2RPV-5LoHJf1706GJoxzTB63BvLkvTRUI2Bc_LpcQFXjx/exec";

// Obtener usuario logueado
let username = localStorage.getItem("username");
let userId = localStorage.getItem("userId");

if(!username){
  alert("No hay usuario logueado");
  window.location.href = "login.html";
}

// Cargar turnos del usuario
async function cargarTurnosUsuario(){
  const ticketsDiv = document.getElementById("ticketsContainer");
  ticketsDiv.innerHTML = "Cargando...";
  
  try {
    const res = await fetch(`${API_URL}?action=getTurnosUsuario&username=${username}&userId=${userId}`);
    const data = await res.json();
    console.log("Respuesta API:", data);

    // Verificar si hay turnos
    let turnosUsuario = [];
    if(data.turnos && typeof data.turnos === "object"){
      Object.keys(data.turnos).forEach(profId => {
        if(Array.isArray(data.turnos[profId])){
          turnosUsuario.push(...data.turnos[profId]);
        }
      });
    }

    if(turnosUsuario.length === 0){
      ticketsDiv.innerHTML = "<p>No hay turnos reservados.</p>";
      return;
    }

    // Mostrar turnos
    ticketsDiv.innerHTML = "";
    turnosUsuario.forEach(t => {
      const div = document.createElement("div");
      div.innerHTML = `
        <h2>${t.profesional}</h2>
        <p>${t.fecha} ${t.hora}</p>
        <p>${t.nombre} ${t.apellido}</p>
        <button onclick="eliminarTurno('${t.fecha}','${t.hora}','${t.profesionalId}','${t.dni}')">Eliminar turno</button>
        <hr>
      `;
      ticketsDiv.appendChild(div);
    });

  } catch(e){
    console.error(e);
    ticketsDiv.innerHTML = "<p>Error al cargar turnos.</p>";
  }
}

// Funci√≥n para eliminar turno
async function eliminarTurno(fecha, hora, profesionalId, dni){
  if(!confirm("Deseas eliminar este turno?")) return;
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "deleteReserva",
        username,
        userId,
        fecha,
        hora,
        profesionalId,
        dni
      })
    });
    const result = await res.json();
    if(result.status === "ok"){
      alert("Turno eliminado correctamente");
      cargarTurnosUsuario();
    } else {
      alert("Error al eliminar turno: " + (result.msg || ""));
    }
  } catch(e){
    console.error(e);
  }
}

document.addEventListener("DOMContentLoaded", cargarTurnosUsuario);
</script>

</body>
</html>
