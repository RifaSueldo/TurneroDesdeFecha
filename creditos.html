<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comprar Cr√©ditos</title>
<style>
  body { font-family: Arial; padding:20px; text-align:center; }
  button { padding:8px 15px; margin:5px; cursor:pointer; }
  input { padding:5px; width:60px; text-align:center; }
</style>
</head>
<body>
  <h2>Usuario: <span id="usernameDisplay"></span></h2>
  <p>Cr√©ditos actuales: <span id="creditosActuales">Cargando...</span></p>

  <label>Cantidad de cr√©ditos:
    <input type="number" id="cantidadCreditos" min="1" value="1">
  </label>
  <br><br>

  <button onclick="comprarCreditos()">üí≥ Comprar Cr√©ditos</button>
  <button onclick="window.close()">‚¨Ö Volver</button>

<script>
let username, userId;

// Obtiene par√°metros de URL
function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

function init() {
  username = getQueryParam('username') || localStorage.getItem('username');
  userId = getQueryParam('userId') || localStorage.getItem('userId');
  if (!username || !userId) return alert("Usuario no identificado");

  document.getElementById("usernameDisplay").innerText = username;

  // Trae cr√©ditos actuales desde Apps Script
  google.script.run.withSuccessHandler(c => {
    document.getElementById("creditosActuales").innerText = c;
  }).getCreditos(username);
}

function comprarCreditos() {
  const cantidad = parseInt(document.getElementById("cantidadCreditos").value, 10);
  if (!cantidad || cantidad <= 0) return alert("Cantidad inv√°lida");

  // Llama a Apps Script para crear preferencia y abrir checkout
  google.script.run.withSuccessHandler(url => {
    if (url) {
      window.open(url, "_blank", "width=500,height=700"); // checkout Mercado Pago
    } else {
      alert("Error al generar link de pago");
    }
  }).crearPreferencia(username, cantidad);
}

// Inicializa al cargar
window.onload = init;
</script>
</body>
</html>
