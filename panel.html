<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Configuración</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:0;
    background:#eee;
  }
  header {
    display:flex; justify-content:space-between; align-items:center;
    background:#ddd; padding:10px;
  }
  header .logo { font-weight:bold; color:#4b2a72; }
  header button {
    background:#444; color:#fff; border:none; padding:8px 15px; cursor:pointer;
    border-radius:4px;
  }
  .menu {
    margin:0; padding:0; list-style:none;
  }
  .menu li {
    background:#4b2a72; color:#fff; padding:15px;
    cursor:pointer; border-bottom:1px solid #333;
    font-weight:bold;
  }
  .menu li:hover { background:#5e3a8e; }
  .submenu {
    display:none; background:#f4f4f4; padding:15px;
  }
  .profesional { border:1px solid #ccc; padding:10px; margin:10px 0; }
  h2 { margin-top:20px; }
  label { margin-right:10px; }
  .hora-checkbox { display:inline-block; margin:2px; }

  /* Calendario Panel */
#calendarioPanel {
  margin: 10px auto;
  max-width: 600px;
  background: #fff;
  color: #533482;
  border-radius: 10px;
  overflow: hidden;
  padding: 10px;
}

#calendarioPanel h4 {
  text-align: center;
  margin-bottom: 8px;
  text-transform: capitalize;
}

#calendarioPanel table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}

#calendarioPanel th, #calendarioPanel td {
  width: 14.28%;
  text-align: center;
  padding: 6px 0;
}

#calendarioPanel td:hover {
  background-color: #f0f0f0;
  cursor: pointer;
  border-radius: 50%;
}

#calendarioPanel td[style*="not-allowed"] {
  cursor: not-allowed;
  color: #999;
}

/* Turnos Panel */
.profesional-turnos {
  margin: 10px auto;
  max-width: 600px;
  text-align: center;
  background: #fff;
  color: #533482;
  padding: 10px;
  border-radius: 8px;
}

.profesional-turnos h4 {
  margin-bottom: 8px;
}

.profesional-turnos .hora {
  display: inline-block;
  margin: 3px;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  transition: all 0.2s;
}

#turnos table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
  color: #333;
}

#turnos th, #turnos td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
  font-size: 0.9rem;
}

#turnos th {
  background-color: #4b2a72;
  color: #fff;
}

#turnos tr:nth-child(even) {
  background-color: #f4f4f4;
}

</style>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyxb4NVrMmUa3b5W-Or9T0JHZJ8XMLZKpq3_P9NWX15EO7RfuVRwabM_wJqmPjhfqN4/exec";
let userId = localStorage.getItem("userId");
let username = localStorage.getItem("username");
let profesionales = [];

// ---------------- INIT ----------------
async function init() {
  if (!userId || !username) {
    alert("Debes iniciar sesión primero.");
    window.location.href = "/login.html";
    return;
  }
  document.getElementById("username").innerText = username;
  await cargarProfesionales();
}

// ---------------- PROFESIONALES ----------------
async function cargarProfesionales() {
  const res = await fetch(`${API_URL}?username=${username}`);
  const data = await res.json();
  if (data.status === "ok") {
    profesionales = data.profesionales;
    renderProfesionales();
  }
}

function renderProfesionales() {
  const cont = document.getElementById("profesionales");
  cont.innerHTML = "";
  profesionales.forEach(prof => {
    const div = document.createElement("div");
    div.className = "profesional";
    div.innerHTML = `
      <h3>${prof.nombre}</h3>
      <button onclick="abrirTurnos('${prof.profesionalId}','${prof.nombre}')">Configurar Turnos</button>
      <button onclick="abrirExcepciones('${prof.profesionalId}','${prof.nombre}')">Excepciones</button>
    `;
    cont.appendChild(div);
  });
}

async function agregarProfesional() {
  const nombre = prompt("Nombre del profesional:");
  if (!nombre) return;
  const formData = new FormData();
  formData.append("action","addProfessional");
  formData.append("userId", userId);
  formData.append("nombre", nombre);
  const res = await fetch(API_URL, {method:"POST", body:formData});
  const data = await res.json();
  if (data.status==="ok") {
    profesionales.push({profesionalId:data.profesionalId, nombre:data.nombre});
    renderProfesionales();
  }
}

// ---------------- TURNOS STANDARD ----------------
function abrirTurnos(profId, nombre) {
  const dias = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
  let html = `<h2>Turnos Standard de ${nombre}</h2>`;
  dias.forEach(d=>{
    html += `<h4>${d}</h4><div>`;
    for (let h=0; h<24; h++) {
      for (let m=0; m<60; m+=15) {
        const hhmm = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
        const id = `${profId}_${d}_${hhmm}`;
        html += `<label class="hora-checkbox"><input type="checkbox" id="${id}" data-dia="${d}" data-hora="${hhmm}" data-hhmm="${hhmm}"> ${hhmm}</label> `;
      }
    }
    html += `</div>`;
  });
  html += `<br><button onclick="guardarTurnos('${profId}')">Guardar</button>`;
  document.getElementById("config").innerHTML = html;
}

async function guardarTurnos(profId) {
  const checkboxes = document.querySelectorAll(`#config input[type=checkbox]`);
  const turnos = [];
  checkboxes.forEach(ch=>{
    if (ch.checked) {
      turnos.push({dia: ch.dataset.dia, hora: ch.dataset.hhmm, visible:1});
    }
  });
  const formData = new FormData();
  formData.append("action","saveTurnosStandard");
  formData.append("profesionalId", profId);
  formData.append("turnos", JSON.stringify(turnos));
  const res = await fetch(API_URL, {method:"POST", body:formData});
  const data = await res.json();
  alert("Turnos guardados correctamente.");
}

// ---------------- EXCEPCIONES ----------------
function abrirExcepciones(profId, nombre) {
  document.getElementById("config").innerHTML = `
    <h2>Excepciones de ${nombre}</h2>
    <label>Fecha: <input type="date" id="exc_fecha"></label><br>
    <label>Hora: <input type="time" id="exc_hora" step="900"></label><br>
    <select id="exc_estado">
      <option value="bloqueado">Bloquear</option>
      <option value="habilitado">Habilitar</option>
    </select><br><br>
    <button onclick="guardarExcepcion('${profId}')">Guardar Excepción</button>
  `;
}

async function guardarExcepcion(profId) {
  const fecha = document.getElementById("exc_fecha").value;
  const hhmm = document.getElementById("exc_hora").value;
  const estado = document.getElementById("exc_estado").value;

  const formData = new FormData();
  formData.append("action","saveExcepcion");
  formData.append("profesionalId", profId);
  formData.append("fecha", fecha);
  formData.append("hora", hhmm);
  formData.append("estado", estado);
  const res = await fetch(API_URL, {method:"POST", body:formData});
  const data = await res.json();
  alert("Excepción guardada correctamente.");
}

</script>
</head>
<body onload="init()">
  <header>
    <div class="logo">TurnoX</div>
    <button onclick="window.location.href='index.html'">Volver</button>
  </header>
  
  <p style="padding:10px;">Usuario: <b id="username"></b></p>
  <ul class="menu">
    
  

    
<li>
    <button onclick="
      window.location.href='/creditos.html?username='
      + encodeURIComponent(username)
      + '&userId=' + encodeURIComponent(userId);
    ">
      💳 Créditos
    </button>
  </li>



 <div id="turnos" class="submenu">
  <h3>Gestión de Turnos</h3>
  <p>Selecciona un profesional y un día para ver los turnos reservados:</p>
  <div id="selectorProfesional"></div>
  <label>Seleccionar día: <input type="date" id="fechaTurnos" onchange="cargarTurnosPanel()"></label>
  <div id="tablaTurnos"></div>
</div>

  <!-- Contenedor del calendario -->
  <div id="calendarioPanel"></div>

  <div id="tablaTurnos" style="margin-top:10px;"></div>
</div>

    
    <li onclick="toggleSection('clientes')">Clientes +</li>
    <div id="clientes" class="submenu">
      <h3>Listado de Clientes</h3>
      <p>Buscador por DNI y listado de datos personales de cada cliente.</p>
    </div>

    <li onclick="toggleSection('config')">Configuración +</li>
    <div id="config" class="submenu">
      <h3>Configuración de horarios</h3>
      <button onclick="agregarProfesional()">Agregar Profesional</button>
  <div id="profesionales"></div>
  <div id="config"></div>
    </div>
  </ul>
  <script>
  // Función para abrir/cerrar secciones
function toggleSection(id) {
  const section = document.getElementById(id);
  const isVisible = section.style.display === "block";
  document.querySelectorAll(".submenu").forEach(s => s.style.display="none");
  if (!isVisible) section.style.display = "block";
}
     </script>
<script>
// ------------------ CARGAR TURNOS EN EL PANEL ------------------

  function renderCalendarioPanel(year = new Date().getFullYear(), month = new Date().getMonth()) {
  const today = new Date();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const calendarDiv = document.getElementById("calendarioPanel");
  calendarDiv.innerHTML = `<h4>${firstDay.toLocaleString("es-ES",{month:"long", year:"numeric"})}</h4>`;

  let table = "<table border='1' style='border-collapse:collapse;width:100%;'><tr>";
  const diasSemana = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
  diasSemana.forEach(d => table += `<th>${d}</th>`);
  table += "</tr><tr>";

  for (let i=0; i<firstDay.getDay(); i++) table += "<td></td>";

  for (let d=1; d<=lastDay.getDate(); d++) {
    const fecha = new Date(year, month, d);
    const fechaStr = fecha.toISOString().split("T")[0];
    const clase = fecha < today ? "style='color:#999;cursor:not-allowed;'" : `onclick="seleccionarDiaPanel('${fechaStr}')" style='cursor:pointer;'`;

    table += `<td ${clase}>${d}</td>`;

    if (fecha.getDay() === 6 && d!==lastDay.getDate()) table += "</tr><tr>";
  }

  table += "</tr></table>";
  calendarDiv.innerHTML += table;

  // Botones de mes
  calendarDiv.innerHTML = `<button onclick="renderCalendarioPanel(${year},${month-1})">← Mes anterior</button>` 
                          + calendarDiv.innerHTML 
                          + `<button onclick="renderCalendarioPanel(${year},${month+1})">Mes siguiente →</button>`;
}

// Función al seleccionar día
function seleccionarDiaPanel(fechaStr) {
  document.getElementById("fechaTurnos").value = fechaStr;
  cargarTurnosPanel();
}

// Inicializar calendario al cargar panel
document.addEventListener("DOMContentLoaded", () => {
  renderSelectorProfesional();
  renderCalendarioPanel();
});

// Cargar listado de profesionales en selector dentro de Turnos
function renderSelectorProfesional() {
  const cont = document.getElementById("selectorProfesional");
  cont.innerHTML = '';
  profesionales.forEach(prof => {
    const btn = document.createElement("button");
    btn.innerText = prof.nombre;
    btn.style.margin = "5px";
    btn.onclick = () => {
      cont.querySelectorAll("button").forEach(b => b.style.fontWeight = "normal");
      btn.style.fontWeight = "bold";
      cont.dataset.profId = prof.profesionalId;
      cargarTurnosPanel();
    };
    cont.appendChild(btn);
  });
}

// Función para cargar turnos por profesional y fecha
async function cargarTurnosPanel() {
  const profId = document.getElementById("selectorProfesional").dataset.profId;
  const fecha = document.getElementById("fechaTurnos").value;
  if (!profId || !fecha) return;

  const res = await fetch(`${API_URL}?action=getTurnos&profesionalId=${profId}&fecha=${fecha}`);
  const data = await res.json();
  if (data.status !== "ok") {
    document.getElementById("tablaTurnos").innerHTML = "Error al cargar turnos";
    return;
  }

  let html = "<table border='1' style='border-collapse:collapse;width:100%;margin-top:10px;'>";
  html += "<tr><th>Hora</th><th>Nombre</th><th>Teléfono</th><th>Email</th></tr>";

  if (data.turnos.length === 0) {
    html += "<tr><td colspan='4' style='text-align:center;'>No hay turnos reservados</td></tr>";
  } else {
    data.turnos.forEach(t => {
      html += `<tr>
        <td>${t.hora}</td>
        <td>${t.nombre} ${t.apellido}</td>
        <td>${t.telefono}</td>
        <td>${t.email}</td>
      </tr>`;
    });
  }

  html += "</table>";
  document.getElementById("tablaTurnos").innerHTML = html;
}

// Inicializar selector de profesionales al cargar el panel
document.addEventListener("DOMContentLoaded", () => {
  renderSelectorProfesional();
});

</script>

</body>
</html>
