<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Configuraci贸n</title>

  <style>
    /* ===== Tipograf铆a y base ===== */
body {
  font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  margin: 0;
  padding: 20px;
  background-color: #533482;
  color: #F2F2F2;
}

h1, h2, h3, h4 {
  font-weight: 600;
  margin: 0 0 10px 0;
}

h1 { text-align: center; font-size: 2rem; }

/* ===== Botones ===== */
button {
  background-color: #533482;
  color: #fff;
  border: none;
  border-radius: 0px;
  padding: 8px 14px;
  margin: 4px 2px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: background-color 0.2s, transform 0.1s;
}

button:hover {
  background-color: #452a7a;
  transform: translateY(-2px);
}

button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

/* ===== Contenedores de profesionales ===== */
.profesional {
  border: 1px solid #ddd;
  padding: 12px;
  margin: 12px 0;
  border-radius: 0px;
  background: linear-gradient(
              135deg,
              #D2B8FF 0%, 
              #fff 25%, 
              #F4EDFF 50%, 
              #fff 75%, 
              #D2B8FF 100%
          ),
          repeating-linear-gradient(
              0deg,
              rgba(255,255,255,0.05) 0px,
              rgba(255,255,255,0.05) 2px,
              transparent 2px,
              transparent 4px
          );
  background-blend-mode: overlay;
  color: #533482;
}

.profesional h3 {
  margin-bottom: 8px;
}

/* ===== Configuraci贸n de turnos ===== */
#config {
  margin-top: 20px;
}

#config h2 {
  margin-bottom: 12px;
  font-size: 18px;
  font-weight: 600;
}

#config h4 {
  margin: 10px 0 6px 0;
  font-size: 14px;
  font-weight: 500;
}

.checkbox-row {
  display: flex;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

label.hora-label {
  margin: 4px;
  display: inline-block;
  cursor: pointer;
}

label.hora-label span {
  display: inline-block;
  padding: 6px 10px;
  font-weight: 600;
  border-radius: 0px;
  transition: all 0.2s;
}

/* Estados de hora */
label.hora-label span.disponible {
  background: #F7F7F7;
  color: #533482;
}
label.hora-label span.disponible:hover {
  background-color: #533482;
  color: #fff;
  transform: translateY(-2px);
  cursor: pointer;
}
label.hora-label span.bloqueado {
  background: #D2B8FF95;
  color: #F7F7F7;
  cursor: not-allowed;
  opacity: 0.6;
  text-decoration: line-through;
}
label.hora-label span.selected {
  background-color: #533482;
  color: #fff;
  transform: translateY(-2px);
}

/* Inputs de rango y selects */
input[type="time"], input[type="date"], select {
  padding: 6px;
  border-radius: 0px;
  border: 1px solid #ccc;
  margin: 4px 0;
  font-size: 14px;
  text-align: center;
}

/* Responsivo */
@media(max-width:650px){
  .checkbox-row label span {
    padding: 4px 6px;
    font-size: 0.9rem;
  }
}
  </style>
</head>
<body onload="init()">
  <button onclick="
      window.location.href='/creditos.html?username='
      + encodeURIComponent(username)
      + '&userId=' + encodeURIComponent(userId);
    ">
       Cr茅ditos
  </button>
  <h1>Panel de Configuraci贸n</h1>
  <p>Usuario: <b id="username"></b></p>
  <button onclick="agregarProfesional()">Agregar Profesional</button>
  <div id="profesionales"></div>
  <div id="config"></div>
</body>
    <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxRK4WyJlagviZGIqibZd8sISBMwW8WzYKCk0Z6qd-JHYwoImVX3MlfdKACo931zGbaxQ/exec"; 
    let userId = localStorage.getItem("userId");
    let username = localStorage.getItem("username");
    let profesionales = [];

    async function init() {
      if (!userId || !username) {
        alert("Debes iniciar sesi贸n primero.");
        window.location.href = "/login.html";
        return;
      }
      document.getElementById("username").innerText = username;
      await cargarProfesionales();
    }

    async function cargarProfesionales() {
      const res = await fetch(`${API_URL}?username=${username}`);
      const data = await res.json();
      if (data.status === "ok") {
        profesionales = data.profesionales;
        renderProfesionales();
      }
    }

    function renderProfesionales() {
      const cont = document.getElementById("profesionales");
      cont.innerHTML = "";
      profesionales.forEach(prof => {
        const div = document.createElement("div");
        div.className = "profesional";
        div.innerHTML = `
          <h3>${prof.nombre}</h3>
          <button onclick="abrirTurnos('${prof.profesionalId}','${prof.nombre}')">Configurar Turnos</button>
          <button onclick="eliminarTurnos('${prof.profesionalId}')"> Limpiar Turnos</button>
        `;
        cont.appendChild(div);
      });
    }

    async function agregarProfesional() {
      const nombre = prompt("Nombre del profesional:");
      if (!nombre) return;
      const formData = new FormData();
      formData.append("action","addProfessional");
      formData.append("userId", userId);
      formData.append("nombre", nombre);
      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      if (data.status === "ok") {
        profesionales.push({profesionalId:data.profesionalId, nombre:data.nombre});
        renderProfesionales();
      }
    }

    // ---------------- CONFIGURACIN DE TURNOS ----------------
    function abrirTurnos(profId, nombre) {
      const dias = ["Lunes","Martes","Mi茅rcoles","Jueves","Viernes","S谩bado","Domingo"];
      let html = `<h2>Turnos Standard de ${nombre}</h2>`;
      
      html += `
        <label>Intervalo: 
          <select id="intervalo">
            <option value="15">15 min</option>
            <option value="20">20 min</option>
            <option value="30" selected>30 min</option>
            <option value="60">60 min</option>
          </select>
        </label><br><br>
      `;

      dias.forEach(d=>{
        html += `
          <h4>${d}</h4>
          Desde <input type="time" id="desde_${d}" value="09:00">
          hasta <input type="time" id="hasta_${d}" value="17:00">
          <button onclick="generarSlots('${profId}','${d}')">Generar</button>
          <div id="slots_${profId}_${d}" class="slots"></div>
        `;
      });

      html += `<br><button onclick="guardarTurnos('${profId}')">Guardar</button>`;
      document.getElementById("config").innerHTML = html;
    }

    function generarSlots(profId, dia) {
      const intervalo = parseInt(document.getElementById("intervalo").value);
      const desde = document.getElementById(`desde_${dia}`).value;
      const hasta = document.getElementById(`hasta_${dia}`).value;
      const cont = document.getElementById(`slots_${profId}_${dia}`);
      cont.innerHTML = "";

      let [h,m] = desde.split(":").map(Number);
      let [hf,mf] = hasta.split(":").map(Number);

      while (h < hf || (h===hf && m < mf)) {
        const hora = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
        const id = `${profId}_${dia}_${hora}`;
        cont.innerHTML += `<label><input type="checkbox" id="${id}" data-dia="${dia}" data-hora="${hora}" checked> ${hora}</label> `;
        m += intervalo;
        if (m >= 60) { m = m-60; h++; }
      }
    }

    async function guardarTurnos(profId) {
      const checkboxes = document.querySelectorAll(`#config input[type=checkbox]`);
      const turnos = [];
      checkboxes.forEach(ch=>{
        turnos.push({dia: ch.dataset.dia, hora: ch.dataset.hora, visible: ch.checked ? 1 : 0});
      });

      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("profesionalId", profId);
      formData.append("turnos", JSON.stringify(turnos));

      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Turnos guardados correctamente.");
    }

    async function eliminarTurnos(profId) {
      if (!confirm("驴Seguro que quieres limpiar todos los turnos de este profesional?")) return;
      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("profesionalId", profId);
      formData.append("turnos", JSON.stringify([]));
      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Turnos eliminados.");
    }
  </script>
</html>
