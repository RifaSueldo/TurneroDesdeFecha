<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Configuraci贸n</title>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyPQ3FCCUIGJPzsC7CepvT9BISkBqL_4exc2-Ukrb1rMX9scdryBvZdjJ11rznkUMvE-A/exec"; // <--- peg谩 aqu铆 tu Web App desplegado
    let userId = localStorage.getItem("userId");
    let username = localStorage.getItem("username");
    let profesionales = [];

    async function init() {
      if (!userId || !username) {
        alert("Debes iniciar sesi贸n primero.");
        window.location.href = "/login.html";
        return;
      }

      document.getElementById("username").innerText = username;
      await cargarProfesionales();
    }

    async function cargarProfesionales() {
      const res = await fetch(`${API_URL}?username=${username}`);
      const data = await res.json();

      if (data.status === "ok") {
        profesionales = data.profesionales;
        renderProfesionales();
      }
    }

    function renderProfesionales() {
      const cont = document.getElementById("profesionales");
      cont.innerHTML = "";

      profesionales.forEach(prof => {
        const div = document.createElement("div");
        div.className = "profesional";
        div.innerHTML = `
          <h3>${prof.nombre}</h3>
          <button onclick="abrirTurnos('${prof.profesionalId}','${prof.nombre}')">Configurar Turnos</button>
          <button onclick="abrirExcepciones('${prof.profesionalId}','${prof.nombre}')">Excepciones</button>
        `;
        cont.appendChild(div);
      });
    }

    async function agregarProfesional() {
      const nombre = prompt("Nombre del profesional:");
      if (!nombre) return;

      const formData = new FormData();
      formData.append("action","addProfessional");
      formData.append("userId", userId);
      formData.append("nombre", nombre);

      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();

      if (data.status === "ok") {
        profesionales.push({profesionalId:data.profesionalId, nombre:data.nombre});
        renderProfesionales();
      }
    }

    // ----- Configuraci贸n de turnos standard -----
    function abrirTurnos(profId, nombre) {
      const dias = ["Lunes","Martes","Mi茅rcoles","Jueves","Viernes","S谩bado","Domingo"];
      let html = `<h2>Turnos Standard de ${nombre}</h2>`;

      dias.forEach(d=>{
        html += `<h4>${d}</h4><div>`;
        for (let h=0; h<24; h++) {
          for (let m=0; m<60; m+=15) {
            const hora = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
            const id = `${profId}_${d}_${hora}`;
            html += `<label><input type="checkbox" id="${id}" data-dia="${d}" data-hora="${hora}"> ${hora}</label> `;
          }
        }
        html += `</div>`;
      });

      html += `<br><button onclick="guardarTurnos('${profId}')">Guardar</button>`;

      document.getElementById("config").innerHTML = html;
    }

    async function guardarTurnos(profId) {
      const checkboxes = document.querySelectorAll(`#config input[type=checkbox]`);
      const turnos = [];
      checkboxes.forEach(ch=>{
        if (ch.checked) {
          turnos.push({dia: ch.dataset.dia, hora: ch.dataset.hora, visible:1});
        }
      });

      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("profesionalId", profId);
      formData.append("turnos", JSON.stringify(turnos));

      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Turnos guardados correctamente.");
    }

    // ----- Excepciones -----
    function abrirExcepciones(profId, nombre) {
      document.getElementById("config").innerHTML = `
        <h2>Excepciones de ${nombre}</h2>
        <label>Fecha: <input type="date" id="exc_fecha"></label><br>
        <label>Hora: <input type="time" id="exc_hora" step="900"></label><br>
        <select id="exc_estado">
          <option value="bloqueado">Bloquear</option>
          <option value="habilitado">Habilitar</option>
        </select><br><br>
        <button onclick="guardarExcepcion('${profId}')">Guardar Excepci贸n</button>
      `;
    }

    async function guardarExcepcion(profId) {
      const fecha = document.getElementById("exc_fecha").value;
      const hora = document.getElementById("exc_hora").value;
      const estado = document.getElementById("exc_estado").value;

      const formData = new FormData();
      formData.append("action","saveExcepcion");
      formData.append("profesionalId", profId);
      formData.append("fecha", fecha);
      formData.append("hora", hora);
      formData.append("estado", estado);

      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Excepci贸n guardada correctamente.");
    }
  </script>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    .profesional { border:1px solid #ccc; padding:10px; margin:10px 0; }
    h2 { margin-top:20px; }
    label { margin-right:10px; }
  </style>
</head>
<body onload="init()">
  <button onclick="
      window.location.href='/creditos.html?username='
      + encodeURIComponent(username)
      + '&userId=' + encodeURIComponent(userId);
    ">
       Cr茅ditos
    </button>
  <h1>Panel de Configuraci贸n</h1>
  <p>Usuario: <b id="username"></b></p>
  <button onclick="agregarProfesional()">Agregar Profesional</button>
  <div id="profesionales"></div>
  <div id="config"></div>
</body>
</html>





