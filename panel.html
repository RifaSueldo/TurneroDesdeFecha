<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de ConfiguraciÃ³n</title>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxRK4WyJlagviZGIqibZd8sISBMwW8WzYKCk0Z6qd-JHYwoImVX3MlfdKACo931zGbaxQ/exec"; 
    let userId = localStorage.getItem("userId");
    let username = localStorage.getItem("username");
    let profesionales = [];

    async function init() {
      if (!userId || !username) {
        alert("Debes iniciar sesiÃ³n primero.");
        window.location.href = "/login.html";
        return;
      }
      document.getElementById("username").innerText = username;
      await cargarProfesionales();
    }

    async function cargarProfesionales() {
      const res = await fetch(`${API_URL}?username=${username}`);
      const data = await res.json();
      if (data.status === "ok") {
        profesionales = data.profesionales;
        renderProfesionales();
      }
    }

    function renderProfesionales() {
      const cont = document.getElementById("profesionales");
      cont.innerHTML = "";
      profesionales.forEach(prof => {
        const div = document.createElement("div");
        div.className = "profesional";
        div.innerHTML = `
          <h3>${prof.nombre}</h3>
          <button onclick="abrirTurnos('${prof.profesionalId}','${prof.nombre}')">Configurar Turnos</button>
          <button onclick="eliminarTurnos('${prof.profesionalId}')">ðŸ—‘ Limpiar Turnos</button>
        `;
        cont.appendChild(div);
      });
    }

    async function agregarProfesional() {
      const nombre = prompt("Nombre del profesional:");
      if (!nombre) return;
      const formData = new FormData();
      formData.append("action","addProfessional");
      formData.append("userId", userId);
      formData.append("nombre", nombre);
      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      if (data.status === "ok") {
        profesionales.push({profesionalId:data.profesionalId, nombre:data.nombre});
        renderProfesionales();
      }
    }

    // ---------------- CONFIGURACIÃ“N DE TURNOS ----------------
    function abrirTurnos(profId, nombre) {
      const dias = ["Lunes","Martes","MiÃ©rcoles","Jueves","Viernes","SÃ¡bado","Domingo"];
      let html = `<h2>Turnos Standard de ${nombre}</h2>`;
      
      html += `
        <label>Intervalo: 
          <select id="intervalo">
            <option value="15">15 min</option>
            <option value="20">20 min</option>
            <option value="30" selected>30 min</option>
            <option value="60">60 min</option>
          </select>
        </label><br><br>
      `;

      dias.forEach(d=>{
        html += `
          <h4>${d}</h4>
          Desde <input type="time" id="desde_${d}" value="09:00">
          hasta <input type="time" id="hasta_${d}" value="17:00">
          <button onclick="generarSlots('${profId}','${d}')">Generar</button>
          <div id="slots_${profId}_${d}" class="slots"></div>
        `;
      });

      html += `<br><button onclick="guardarTurnos('${profId}')">Guardar</button>`;
      document.getElementById("config").innerHTML = html;
    }

    function generarSlots(profId, dia) {
      const intervalo = parseInt(document.getElementById("intervalo").value);
      const desde = document.getElementById(`desde_${dia}`).value;
      const hasta = document.getElementById(`hasta_${dia}`).value;
      const cont = document.getElementById(`slots_${profId}_${dia}`);
      cont.innerHTML = "";

      let [h,m] = desde.split(":").map(Number);
      let [hf,mf] = hasta.split(":").map(Number);

      while (h < hf || (h===hf && m < mf)) {
        const hora = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
        const id = `${profId}_${dia}_${hora}`;
        cont.innerHTML += `<label><input type="checkbox" id="${id}" data-dia="${dia}" data-hora="${hora}" checked> ${hora}</label> `;
        m += intervalo;
        if (m >= 60) { m = m-60; h++; }
      }
    }

    async function guardarTurnos(profId) {
      const checkboxes = document.querySelectorAll(`#config input[type=checkbox]`);
      const turnos = [];
      checkboxes.forEach(ch=>{
        turnos.push({dia: ch.dataset.dia, hora: ch.dataset.hora, visible: ch.checked ? 1 : 0});
      });

      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("profesionalId", profId);
      formData.append("turnos", JSON.stringify(turnos));

      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Turnos guardados correctamente.");
    }

    async function eliminarTurnos(profId) {
      if (!confirm("Â¿Seguro que quieres limpiar todos los turnos de este profesional?")) return;
      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("profesionalId", profId);
      formData.append("turnos", JSON.stringify([]));
      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Turnos eliminados.");
    }
  </script>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    .profesional { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:8px; }
    h2 { margin-top:20px; }
    label { margin-right:10px; }
    .slots { margin:5px 0 15px 0; padding:5px; background:#f9f9f9; border-radius:5px; }
  </style>
</head>
<body onload="init()">
  <button onclick="
      window.location.href='/creditos.html?username='
      + encodeURIComponent(username)
      + '&userId=' + encodeURIComponent(userId);
    ">
      ðŸ’³ CrÃ©ditos
  </button>
  <h1>Panel de ConfiguraciÃ³n</h1>
  <p>Usuario: <b id="username"></b></p>
  <button onclick="agregarProfesional()">Agregar Profesional</button>
  <div id="profesionales"></div>
  <div id="config"></div>
</body>
</html>
