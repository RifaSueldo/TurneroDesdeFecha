<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Configuración</title>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxRK4WyJlagviZGIqibZd8sISBMwW8WzYKCk0Z6qd-JHYwoImVX3MlfdKACo931zGbaxQ/exec"; 
    let userId = localStorage.getItem("userId");
    let username = localStorage.getItem("username");
    let profesionales = [];

    async function init() {
      if (!userId || !username) {
        alert("Debes iniciar sesión primero.");
        window.location.href = "/login.html";
        return;
      }
      document.getElementById("username").innerText = username;
      await cargarProfesionales();
    }

    async function cargarProfesionales() {
      const res = await fetch(`${API_URL}?username=${username}`);
      const data = await res.json();
      if (data.status === "ok") {
        profesionales = data.profesionales;
        renderProfesionales();
      }
    }

    function renderProfesionales() {
      const cont = document.getElementById("profesionales");
      cont.innerHTML = "";
      profesionales.forEach(prof => {
        const div = document.createElement("div");
        div.className = "profesional";
        div.innerHTML = `
          <h3>${prof.nombre}</h3>
          <button onclick="abrirTurnos('${prof.profesionalId}','${prof.nombre}')">Configurar Turnos</button>
          <button onclick="eliminarTurnos('${prof.profesionalId}')">🗑 Limpiar Turnos</button>
        `;
        cont.appendChild(div);
      });
    }

    async function agregarProfesional() {
      const nombre = prompt("Nombre del profesional:");
      if (!nombre) return;
      const formData = new FormData();
      formData.append("action","addProfessional");
      formData.append("userId", userId);
      formData.append("nombre", nombre);
      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      if (data.status === "ok") {
        profesionales.push({profesionalId:data.profesionalId, nombre:data.nombre});
        renderProfesionales();
      }
    }

    // ---------------- CONFIGURACIÓN DE TURNOS ----------------
    function abrirTurnos(profId, nombre) {
      const dias = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
      let html = `<h2>Turnos Standard de ${nombre}</h2>`;
      
      html += `
        <label>Intervalo: 
          <select id="intervalo">
            <option value="15">15 min</option>
            <option value="20">20 min</option>
            <option value="30" selected>30 min</option>
            <option value="60">60 min</option>
          </select>
        </label><br><br>
      `;

      dias.forEach(d=>{
        html += `
          <h4>${d}</h4>
          Desde <input type="time" id="desde_${d}" value="09:00">
          hasta <input type="time" id="hasta_${d}" value="17:00">
          <button onclick="generarSlots('${profId}','${d}')">Generar</button>
          <div id="slots_${profId}_${d}" class="slots"></div>
        `;
      });

      html += `<br><button onclick="guardarTurnos('${profId}')">Guardar</button>`;
      document.getElementById("config").innerHTML = html;
    }

    function generarSlots(profId, dia) {
      const intervalo = parseInt(document.getElementById("intervalo").value);
      const desde = document.getElementById(`desde_${dia}`).value;
      const hasta = document.getElementById(`hasta_${dia}`).value;
      const cont = document.getElementById(`slots_${profId}_${dia}`);
      cont.innerHTML = "";

      let [h,m] = desde.split(":").map(Number);
      let [hf,mf] = hasta.split(":").map(Number);

      while (h < hf || (h===hf && m < mf)) {
        const hora = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
        const id = `${profId}_${dia}_${hora}`;
        cont.innerHTML += `<label><input type="checkbox" id="${id}" data-dia="${dia}" data-hora="${hora}" checked> ${hora}</label> `;
        m += intervalo;
        if (m >= 60) { m = m-60; h++; }
      }
    }

    async function guardarTurnos(profId) {
      const checkboxes = document.querySelectorAll(`#config input[type=checkbox]`);
      const turnos = [];
      checkboxes.forEach(ch=>{
        turnos.push({dia: ch.dataset.dia, hora: ch.dataset.hora, visible: ch.checked ? 1 : 0});
      });

      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("profesionalId", profId);
      formData.append("turnos", JSON.stringify(turnos));

      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Turnos guardados correctamente.");
    }

    async function eliminarTurnos(profId) {
      if (!confirm("¿Seguro que quieres limpiar todos los turnos de este profesional?")) return;
      const formData = new FormData();
      formData.append("action","saveTurnosStandard");
      formData.append("profesionalId", profId);
      formData.append("turnos", JSON.stringify([]));
      const res = await fetch(API_URL, {method:"POST", body:formData});
      const data = await res.json();
      alert("Turnos eliminados.");
    }
  </script>
  <style>
    /* ===== Tipografía y base ===== */
body {
  font-family: 'Montserrat', Arial, sans-serif;
  background-color: #f5f5f5;
  color: #333;
  padding: 20px;
  margin: 0;
}

/* ===== Botones ===== */
button {
  background-color: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  margin: 4px 2px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s, transform 0.1s;
}

button:hover {
  background-color: #0056b3;
  transform: translateY(-1px);
}

button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

/* ===== Contenedores de profesionales ===== */
.profesional {
  border: 1px solid #ddd;
  border-radius: 6px;
  background-color: #fff;
  padding: 12px;
  margin: 12px 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.profesional h3 {
  margin: 0 0 8px 0;
  font-weight: 600;
  font-size: 16px;
}

/* ===== Configuración de turnos ===== */
#config {
  margin-top: 20px;
}

#config h2 {
  margin-bottom: 12px;
  font-size: 18px;
  font-weight: 600;
}

#config h4 {
  margin: 10px 0 6px 0;
  font-size: 14px;
  font-weight: 500;
}

/* ===== Checkboxes ===== */
#config label {
  display: inline-block;
  margin: 2px 4px;
  padding: 4px 6px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s;
}

#config input[type="checkbox"] {
  display: none;
}

/* Estado activo */
#config input[type="checkbox"]:checked + span {
  background-color: #28a745;
  color: #fff;
}

/* Estado deshabilitado (visible=0) */
#config input[type="checkbox"].inactive + span {
  background-color: #dc3545;
  color: #fff;
}

/* Hover */
#config label:hover span {
  background-color: #17a2b8;
  color: #fff;
}

/* ===== Inputs de rango ===== */
input[type="time"],
input[type="date"],
select {
  padding: 6px;
  border-radius: 4px;
  border: 1px solid #ccc;
  margin: 4px 0;
  font-size: 14px;
}

/* ===== Separadores y contenedores ===== */
.day-row {
  margin-bottom: 12px;
}

.checkbox-row {
  display: flex;
  flex-wrap: wrap;
}
  </style>
</head>
<body onload="init()">
  <button onclick="
      window.location.href='/creditos.html?username='
      + encodeURIComponent(username)
      + '&userId=' + encodeURIComponent(userId);
    ">
      💳 Créditos
  </button>
  <h1>Panel de Configuración</h1>
  <p>Usuario: <b id="username"></b></p>
  <button onclick="agregarProfesional()">Agregar Profesional</button>
  <div id="profesionales"></div>
  <div id="config"></div>
</body>
</html>
